# Linux版のインストール手順

## **OMFLOWサーバーのインストール** (1.2.0.0 以降のバージョンをインストール)

>OMFLOWサーバーをインストールするための環境を準備します。
>
>このドキュメントでは、Ubuntu20.04、
>
>Pythonバージョン3.8.xを例として使用します。
>
>他のオペレーティングシステムについては、次の準備手順を参照して準備を完了してください。

### STEP1、必要なPython3環境とOMFLOWパッケージを準備する

Ubuntuに必要なパッケージのインストール例

```
# パッケージリポジトリの更新
sudo apt-get update -y
# パッケージリポジトリの追加
sudo add-apt-repository ppa:deadsnakes/ppa -y
# パッケージリポジトリの更新
sudo apt-get update -y
# python3.11と関連パッケージをインストール
sudo apt-get install -y python3.11 python3.11-dev python3.11-venv python3-pip apache2-dev
```

### 2. python 3.11 を環境変数に設定する(python3.11 がコマンドで python3 を呼び込める)

```
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
```

### 3. ウェブサーバーのインストール Apache Server

```
sudo apt-get install -y apache2
```

### 4. python3.11の仮想環境を/opt/omflowフォルダの下に作成します

```
sudo mkdir /opt/omflow
sudo python3 -m venv /opt/omflow/python
```

### 5. 仮想環境に入り、pythonパッケージをインストールします

> python パッケージリスト
>
> - wheel
> - django==4.2
> - ldap3
> - mod_wsgi
> - openpyxl
> - requests
> - python-docx
> - DB で利用する python パッケージ
> - その他のパッケージ…
> - オンラインインストール版（インターネット接続が必要です）

```bash
    # rootに切り替える
    sudo su
    # 仮想環境に入る
    source /opt/omflow/python/bin/activate
    # wheelをインストール
    pip install wheel
    # 必要なパッケージのインストールし、その他のパッケージのインストールはご自分で判断してください。
    pip install django==4.2 ldap3 mod_wsgi openpyxl requests python-docx
```

### 6. omflow フォルダを解凍

OMFLOW のインストールファイルを解凍します

```
cd /opt/omflow
sudo tar zxvf [OMFLOWインストールファイルのパス]
```

### 7. フォルダ名を **server** に変更します

```
sudo mv /opt/omflow/omflow /opt/omflow/server
```

### 8. データベースの準備

デフォルトのデータベースは SQLite です。 他のデータベースを選択したい場合は、ウェブサイトを参照してください。

[Django database config](https://docs.djangoproject.com/en/2.2/ref/databases/)

#### Linux Linuxインストールデータベースパッケージの比較表:

#### UBUNTU

| **MySQL** |
| --- |
| apt update -y &#x26;&#x26; apt upgrade -y <br>apt -y install software-properties-common <br>add-apt-repository 'deb <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> bionic main' <br>apt update -y <br>apt install -y python-mysqldb <br>apt install -y libmysqlclient-dev |

#### CentOS

|      **SQLite**       |
| :-------------------: |
| dnf install -y sqlite |

別のデータベースを選択する場合は、事前にデータベースを構築して、対応する権限を付与してください。 \
次のデータベースは、追加パッケージをインストールする必要があります。（pipインストールを使用)

> データベースパッケージをインストールする前に仮想環境に入ってください `source /opt/omflow/python/bin/activate`

#### 必要パッケージ対応表:

|   PostgreSQL    |  Oracle   |    SQL Server    |    MySQL    |
| :-------------: | :-------: | :--------------: | :---------: |
| psycopg2-binary | cx_Oracle |   django-mssql   |   pymysql   |
|                 |           |   django-pytds   | mysqlclient |
|                 |           | django-sqlserver |             |
|                 |           |  django-pyodbc   |             |

/opt/omflow/server/omflow/settings.py ファイルを変更します。
以下は settings.py の変更例です。

**SQLite** 
```
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": os.path.join(BASE_DIR, "db.omflow"),
        "OPTIONS": {
            "timeout": 300,
        }
    }
}
```

**PostgreSQL**
```
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": "<データベース名>",
        "USER": "<ユーザー名>",
        "PASSWORD": "<パスワード>",
        "HOST": "<Database IP Address>",
        "PORT": "<Database Port No.>",
        "OPTSIONS": {
            "connect_timeout": 300
        }
    }
}
```

**MySQL**

```
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        "NAME": "<データベース名>",
        "USER": "<ユーザー名>",
        "PASSWORD": "<パスワード>",
        "HOST": "<Database IP Address>",
        "PORT": "<Database Port No.>",
        "OPTSIONS": {
            "connect_timeout": 300
        }
        }
    }
}
```

**Oracle**

```
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.oracle",
        "NAME": "<データベース名>",
        "USER": "<ユーザー名>",
        "PASSWORD": "<パスワード>",
        "HOST": "<Database IP Address>",
        "PORT": "<Database Port No.>"
    }
}
```

**SQL Server**

```
DATABASES = {
    "default": {
        "ENGINE": "sql_server.pyodbc",
        "NAME": "<データベース名>",
        "USER": "<ユーザー名>",
        "PASSWORD": "<パスワード>",
        "HOST": "<Database IP Address>",
        "PORT": "<Database Port No.>",
        "OPTIONS": {
            "driver": "",
            "MARS_Connection": True,
        }
    }
}
```

### 9. omflow\_config.sh ファイルの実行

/opt/omflow/server ディレクトリへ移動

```
cd /opt/omflow/server
sudo ./omflow_config.sh
```

### 19. タイプに server を選択

> omflow type : server

#### 実行例

![omflow type に serverを入力 server](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_1.jpg)

![必須入力情報](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_2.png)

#### django.conf 設定ファイル

ファイルを実行することによって、django.conf(apache設定ファイル)がapacheディレクトリ内に複製されます。 \
コマンドにて確認できます。

檢視

```
sudo vi /etc/apache2/sites-available/django.conf
```

django.conf 設定ファイルを起動

```
sudo a2ensite django.conf
```

apache デフォルトファイルを停止

```
sudo a2dissite 000-default.conf
```

### 11. omflow_server サービス

omflow_server サービスを起動

```
sudo /opt/omflow/server/omflow_server start
```

omflow_server サービスを停止

```
sudo /opt/omflow/server/omflow_server stop
```

omflow_server のサービス状態を確認

```
sudo /opt/omflow/server/omflow_server status
```

![サービス状態は running](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_3.jpg)


### 12. OMFLOWの利用開始

## OMFLOW Collectorをインストールします (1.2.0.0 以降のバージョンをインストールしてください)

> OMFLOW Collector をインストールする前の環境準備。
>
> ここでは Ubuntu 24.04，
>
> Python バージョンを 3.11.x の例です，
>
> その他のOSの場合は、以下の手順を参考に準備を完了してください。

### 1. Python3 の環境及び OMFLOW パッケージを準備します

Ubuntu 必要なパッケージのインストール例

```
# パッケージリポジトリの更新
sudo apt-get update -y
# パッケージリポジトリの追加
sudo add-apt-repository ppa:deadsnakes/ppa -y
# パッケージリポジトリの更新
sudo apt-get update -y
# python3.11と関連パッケージをインストール
sudo apt-get install -y python3.11 python3.11-dev python3.11-venv python3-pip
```

### 2. python 3.11 を環境変数に設定する(python3.11 がコマンドで python3 を呼び込める

```
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
```

### 3. OMFLOW の Python 実行環境を設置

```bash
sudo mkdir /opt/omflow
sudo python3 -m venv /opt/omflow/python
```

### 4. OMFLOWに必要なパッケージをインストール

仮想環境に入り、必要なパッケージをインストールします。

```bash
# rootに切り替える
sudo su
# 仮想環境に入る
source /opt/omflow/python/bin/activate
# 必要なパッケージをインストール
pip install django==4.2 openpyxl requests python-docx
```
> その他のパッケージの要否はCollectorの用途により変わります。【**データ收集>コレクターキット**】の説明をご確認ください。

### 5. OMFLOWディレクトリの解凍

OMFLOWインストールファイルの解凍

/tmp/omflow.tar.gz を解凍します。


```
cd /opt/omflow
sudo tar zxvf [OMFLOWインストールファイルのパス]
```

### 6. フォルダ名を **collector** に変更します

```
sudo mv /opt/omflow/omflow /opt/omflow/collector
```

### 7. omflow_config.sh ファイルの実行

/opt/omflow/collector ディレクトリへ移動

```
cd /opt/omflow/collector
sudo ./omflow_config.sh
```

### 8. タイプに collector を選択

> omflow type : collector

![omflow type に collector を入力](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_4.png)

### 9. 必須入力情報の入力

このステップでは **/opt/omflow/collector/omflow/settings.py** を変更します

- **Collector IP : ホスト IP**
- **Collector port : 5168**
- **Server IP : OMFLOWserver IP**
- **Server port : OMFLOWserver port**
- **Server protocol : OMFLOW server protocol**

![必須入力情報を入力](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_5.png)

### 9. omflow_collecter サービス

omflow_collector サービスを起動

```
sudo /opt/omflow/collector/omflow_collector start
```

omflow_collector サービスを停止

```
sudo /opt/omflow/collector/omflow_collector stop
```

omflow_collector のサービス状態を確認

```
sudo /opt/omflow/collector/omflow_collector status
```

![のサービス状態はunning](https://syscomgo.com/wp-content/uploads/2023/11/OMFLOW_3-2_6.png)

## OMFLOW　Patchをインストールします

### ステップ1，解壓縮 Patch ファイルを解凍します

```
sudo tar xvf [Patchファイルのパス]
```

### ステップ2，patch.sh を実行します

```
cd [解凍後に作成されるフォルダパス]
sudo ./patch.sh
```
