# Linux

## Linux版のインストール

### OMFLOWサーバのインストール <a href="#kai-shi-an-zhuang-omflow-server" id="kai-shi-an-zhuang-omflow-server"></a>

OMFLOWサーバをインストールするための環境を準備します。このドキュメントでは、Ubuntu20.04とCentOS 8、Pythonバージョン3.8.xを例として使用します。他のオペレーティングシステムについては、次の準備手順を参照して準備を完了してください。

### STEP1、Python3環境を準備する <a href="#di-yi-bu-zhou-bi-xu-zhun-bei-python3-de-huan-jing" id="di-yi-bu-zhou-bi-xu-zhun-bei-python3-de-huan-jing"></a>

Ubuntu インストール例

```
apt-get install python3
```

CentOS インストール例

```
yum install python3
```

### STEP2、WebサーバApache Serverをインストールする <a href="#di-er-bu-zhou-an-zhuang-wang-ye-si-fu-qi-apache-server" id="di-er-bu-zhou-an-zhuang-wang-ye-si-fu-qi-apache-server"></a>

Ubuntu Apacheインストール例

```
sudo apt update
apt-get install apache2
```

CentOS Apacheインストール例

```
yum install httpd
```

### STEP3、OMFLOW用のPython実行環境を構築する <a href="#di-si-bu-zhou-jian-li-omflow-de-python-zhi-hang-huan-jing" id="di-si-bu-zhou-jian-li-omflow-de-python-zhi-hang-huan-jing"></a>

```
mkdir /opt/omflow
python3 -m venv /opt/omflow/python
```

### STEP4、OMFLOWに必要なパッケージをインストールする <a href="#di-wu-bu-zhou-an-zhuang-omflow-bi-yao-tao-jian" id="di-wu-bu-zhou-an-zhuang-omflow-bi-yao-tao-jian"></a>

仮想環境に入り、必要なパッケージをインストールします

```
source /opt/omflow/python/bin/activate
pip install wheel
python /usr/lib/python3.8/test/libregrtest/setup.py bdist_wheel
pip install django==2.2 ldap3 mod_wsgi
```

### STEP5、omflowディレクトリの解凍 <a href="#di-liu-bu-zhou-jie-ya-suo-omflow-zi-liao-jia" id="di-liu-bu-zhou-jie-ya-suo-omflow-zi-liao-jia"></a>

/tmp/omflow.tar.gzを解凍します

```
cd /opt/omflow 
tar zxvf /tmp/omflow.tar.gz
```

ディレクトリ名を **server** に変更します

```
mv /opt/omflow/omflow /opt/omflow/server
```

### STEP6、データベースの準備 <a href="#di-qi-bu-zhou-zi-liao-ku-zhun-bei" id="di-qi-bu-zhou-zi-liao-ku-zhun-bei"></a>

データベースはデフォルトでSQLiteです。別のデータベースを選択する場合は、Webサイトを参照してください。

[Django database config](https://docs.djangoproject.com/en/2.2/ref/databases/)​

#### UBUNTU

| MySQL                                                                                                                                                                                                                                                                                                             |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>apt update -y &#x26;&#x26; apt upgrade -y <br>apt -y install software-properties-common <br>add-apt-repository 'deb <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> bionic main' <br>apt update -y <br>apt install -y python-mysqldb <br>apt install -y libmysqlclient-dev</p> |

#### CentOS

| SQLite                |
| --------------------- |
| dnf install -y sqlite |

別のデータベースを選択する場合は、事前にデータベースを構築して、対応する権限を付与してください。 次のデータベースは、追加パッケージをインストールする必要があります。（pipインストールを使用）

{% hint style="warning" %}
**データベースパッケージをインストールする前に仮想環境に入ってください**`source /opt/omflow/python/bin/activate`
{% endhint %}

必要パッケージ対応表:

| PostgreSQL |   Oracle   |    SQL Server    |
| :--------: | :--------: | :--------------: |
|  psycopg2  | cx\_Oracle |   django-mssql   |
|            |            |   django-pytds   |
|            |            | django-sqlserver |
|            |            |   django-pyodbc  |

**/opt/omflow/server/omflow/settings.py ファイルを変更します**\
**以下はsettings.py の変更例**

**SQLite** `DATABASES = { "default": { "ENGINE": "django.db.backends.sqlite3", "NAME": os.path.join(BASE_DIR, "db.omflow"), "OPTIONS": {"timeout": 300,} } }`

**PostgreSQL** `DATABASES = { "default": { "ENGINE": "django.db.backends.postgresql", "NAME": "<データベース名>", "USER": "<ユーザ名>", "PASSWORD": "<パスワード>", "HOST": "<Database IP Address>", "PORT": "<Database Port No.>", "OPTSIONS":{"connect_timeout":300} } }`

**MySQL** `DATABASES = { "default": { "ENGINE": "django.db.backends.mysql", "NAME": "<データベース名>", "USER": "<ユーザ名>", "PASSWORD": "<パスワード>", "HOST": "<Database IP Address>", "PORT": "<Database Port No.>", "OPTSIONS":{"connect_timeout":300} } }`

**Oracle** `DATABASES = { "default": { "ENGINE": "django.db.backends.oracle", "NAME": "<データベース名>", "USER": "<ユーザ名>", "PASSWORD": "<パスワード>", "HOST": "<Database IP Address>", "PORT": "<Database Port No.>" } }`

**SQL Server** `DATABASES = { "default": { "ENGINE": "sql_server.pyodbc", "NAME": "<データベース名>", "USER": "<ユーザ名>", "PASSWORD": "<パスワード>", "HOST": "<Database IP Address>", "PORT": "<Database Port No.>", "OPTIONS":{"driver":"","MARS_Connection": True,} } }`

### STEP7、omflow\_config.sh ファイルの実行 <a href="#di-ba-bu-zhou-zhi-hang-omflowconfigsh-dang-an" id="di-ba-bu-zhou-zhi-hang-omflowconfigsh-dang-an"></a>

/opt/omflow/server ディレクトリへ移動

```
cd /opt/omflow/server 
./omflow_config.sh
```

{% hint style="info" %}
Pythonのバージョンが3.8ではない場合、/opt/omflow/server/omflow/settings.py中のバージョンを3.8から使用しているバージョン番号へ修正してください。
{% endhint %}

### STEP8、serverタイプを選択 <a href="#di-jiu-bu-zhou-lei-xing-xuan-ze-wei-server" id="di-jiu-bu-zhou-lei-xing-xuan-ze-wei-server"></a>

> omflow type : server

#### Ubuntu 実行例 <a href="#ubuntu-zhi-hang-fan-li" id="ubuntu-zhi-hang-fan-li"></a>

![omflow type にserverを入力](https://gblobscdn.gitbook.com/assets%2F-M6SrengyyhO1h0\_BsJ\_%2F-MBqfJS6C\_rkH2evrLe7%2F-MBqi3YpfJaTCDc2Y8ms%2F2020-07-10\_111126.png?alt=media\&token=13e875c7-68e7-4cc0-8211-1bddef7ad215)

![必須入力情報](https://3346898383-files.gitbook.io/\~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-M6SrengyyhO1h0\_BsJ\_-887967055%2Fuploads%2Frk7Gk1xceKjwzPkKbCJs%2Flinux%E5%AE%89%E8%A3%9D.png?alt=media\&token=7643a3c8-deab-49b7-95bc-f0a124699172)

#### django.conf 設定ファイル <a href="#qi-yong-djangoconf-she-ding-dang" id="qi-yong-djangoconf-she-ding-dang"></a>

実行ファイルにより、django.conf (apache設定ファイル) はapacheディレクトリに複製されています。

コマンドにて確認できます。

Ubuntuでの確認

```
vi /etc/apache2/sites-available/django.conf
```

CentOSでの確認

```
vi /etc/httpd/conf.d/django.conf
```

Ubuntuにおいてdjango.conf設定ファイルを使用開始

```
sudo a2ensite django.conf
```

Ubuntuにおいてapacheのデフォルト設定ファイルの利用を停止

```
sudo a2dissite 000-default.conf
```

### STEP9、 omflow\_server サービス <a href="#di-shi-bu-zhou-qi-yong-omflowserver-fu-wu" id="di-shi-bu-zhou-qi-yong-omflowserver-fu-wu"></a>

omflow\_server サービスの起動

```
/opt/omflow/server/omflow_server start
```

omflow\_server サービスの停止

```
/opt/omflow/server/omflow_server stop
```

omflow\_server サービス状態の確認

```
/opt/omflow/server/omflow_server status
```

<figure><img src="https://3346898383-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-M6SrengyyhO1h0_BsJ_-887967055%2Fuploads%2FGf2ZU0mbgt5TlH33s7iG%2FServer%E7%8B%80%E6%85%8B.jpg?alt=media&#x26;token=54cb8ad2-c8ac-41d2-b7a0-1a29eb65cb7a" alt=""><figcaption><p>サービス状態 running</p></figcaption></figure>

### STEP10、OMFLOWを利用開始 <a href="#di-shi-yi-bu-zhou-kai-shi-xiang-yong-omflow" id="di-shi-yi-bu-zhou-kai-shi-xiang-yong-omflow"></a>

## OMFLOW Collectorのインストール <a href="#kai-shi-an-zhuang-omflow-collector" id="kai-shi-an-zhuang-omflow-collector"></a>

### STEP1、Python3環境の準備 <a href="#di-yi-bu-zhou-bi-xu-zhun-bei-python3-de-huan-jing" id="di-yi-bu-zhou-bi-xu-zhun-bei-python3-de-huan-jing"></a>

Ubuntuにおけるインストール例

```
apt-get install python3
```

CentOSにおけるインストール例

```
yum install python3
```

### STEP2、OMFLOW用のPython実行環境の構築 <a href="#di-si-bu-zhou-jian-li-omflow-de-python-zhi-hang-huan-jing" id="di-si-bu-zhou-jian-li-omflow-de-python-zhi-hang-huan-jing"></a>

```
mdkir /opt/omflow
python3 -m venv /opt/omflow/python
```

{% hint style="warning" %}
仮想環境を構築できない場合、`apt-get install python3-venv`でパッケージをインストールしてください。
{% endhint %}

### STEP3、OMFLOWに必要なパッケージをインストール <a href="#di-wu-bu-zhou-an-zhuang-omflow-bi-yao-tao-jian" id="di-wu-bu-zhou-an-zhuang-omflow-bi-yao-tao-jian"></a>

仮想環境に入り、必要なパッケージをインストールします。

```
source /opt/omflow/python/bin/activate
pip install django==2.2
```

{% hint style="info" %}
その他のパッケージの要否はCollectorの用途により変わります。Collectorパッケージの説明を確認ください。
{% endhint %}

### STEP4、omflowディレクトリの解凍

/tmp/omflow.tar.gzを解凍します。

```
cd /opt/omflow 
tar zxvf /tmp/omflow.tar.gz
```

ディレクトリ名を **collector** に変更します。

```
mv /opt/omflow/omflow /opt/omflow/collector
```

### STEP5、omflow\_config.sh ファイルを実行 <a href="#di-ba-bu-zhou-zhi-hang-omflowconfigsh-dang-an" id="di-ba-bu-zhou-zhi-hang-omflowconfigsh-dang-an"></a>

/opt/omflow/collectorディレクトリに移動します。

```
cd /opt/omflow/collector 
./omflow_config.sh
```

### STEP6、collectorタイプを選択 <a href="#di-liu-bu-zhou-lei-xing-xuan-ze-wei-collector" id="di-liu-bu-zhou-lei-xing-xuan-ze-wei-collector"></a>

> omflow type : collector

![omflow typeでcollectorを入力](https://3346898383-files.gitbook.io/\~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-M6SrengyyhO1h0\_BsJ\_-887967055%2Fuploads%2FG52k9tVbfeyRhB7T6h2g%2F%E5%AE%89%E8%A3%9D%E9%A1%9E%E5%9E%8B%E6%94%B6%E9%9B%86%E5%99%A8.PNG?alt=media\&token=452f54bc-47ed-475b-81f2-0e5755893fd0)

### STEP7、必須情報を入力 <a href="#di-qi-bu-zhou-shu-ru-bi-tian-zi-xun" id="di-qi-bu-zhou-shu-ru-bi-tian-zi-xun"></a>

このSTEPにより、**/opt/omflow/collector/omflow/settings.py** が変更されます。

* **Collector IP : CollectorをインストールしたホストのIP**
* **Collector port : 5168**
* **Server IP : omflow server IP**
* **Server port : omflow server port**
* **Server protocol : OMFLOW server protocol**

![必須情報を入力してください](https://3346898383-files.gitbook.io/\~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-M6SrengyyhO1h0\_BsJ\_-887967055%2Fuploads%2FeKnY6j2eIj2pFvC7lp31%2F%E6%94%B6%E9%9B%86%E5%99%A8%E5%AE%89%E8%A3%9D.PNG?alt=media\&token=128b2d03-60bc-4912-b249-fd784fb88cca)

### STEP8、omflow\_collecter サービス <a href="#di-ba-bu-zhou-qing-jian-cha-omflowcollecter-fu-wu-zhuang-tai" id="di-ba-bu-zhou-qing-jian-cha-omflowcollecter-fu-wu-zhuang-tai"></a>

omflow\_collector サービスの起動

```
/opt/omflow/collector/omflow_collector start
```

omflow\_collector サービスの停止

```
/opt/omflow/collector/omflow_collector stop
```

omflow\_collector サービス状態の確認

```
/opt/omflow/collector/omflow_collector status
```

![サービス状態 running](https://3346898383-files.gitbook.io/\~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-M6SrengyyhO1h0\_BsJ\_-887967055%2Fuploads%2FzkzGQ8O5QFq2RBYWHGZs%2F%E6%94%B6%E9%9B%86%E5%99%A8%E7%8B%80%E6%85%8B.PNG?alt=media\&token=4fa929a2-bc0a-41fe-885e-bc91b7a8f2e5)

## OMFLOW Patchのインストール

### STEP1、Patchファイルの解凍

```
tar xvf omflow_patch_1_x_x_x.tar.gz
```

### STEP2、patch.shの実行

```
cd omflow_patch_1_x_x_x/
./patch.sh
```
